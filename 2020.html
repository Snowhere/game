<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>1010!</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>
    <p id="scoreInfo">得分:<span id="score">0</span></p>
    <div id="title">
        <h1 id="titleInfo"><span style="color: #1874CD;">10</span><span style="color: #FFC125;">10</span><span style="color: #CD2626;">!</span></h1>
    </div>
    <div id="table">
    </div>
    <p class="info">当前有<span></span>名玩家.轮到你操作了.倒计时<span id="time"></span>秒</p>
    <p id="gg" class="info">作者:<a href="http://snowhere.me">Snowhere</a>.感谢:<a href="http://kinice.top">kinice</a></p>
    <div id="bricks">
    </div>
    <script type="text/javascript" src="js/object.js"></script>
    <script type="text/javascript" src="js/dict.js"></script>
    <script type="text/javascript" src="js/main.js"></script>
    <script type="text/javascript">
    var gameWidth = document.body.clientWidth < 520 ? (document.body.clientWidth - 50) : 500;
    document.getElementById('gg').style.display = 'none';
    /**
     * game start
     */
    //init table
    var tableRow = 8;
    var tableCol = 8;
    var table = new Table(gameWidth, tableRow, tableCol);
    time();
    //init bircks
    var brickAmount = 3;
    var brickList = new BrickList(gameWidth, brickAmount);

    var squareWidth = gameWidth / tableCol;
    var score = 0;
    //mouse event
    function up(e) {
        e.preventDefault();
        if ('ontouchend' in document) {
            e = e.touches[0];
        }
        var updatePosition = false;
        var dragPosition = getPosition(param.dragBrick.dom);
        var tablePosition = getPosition(table.dom);
        if (dragPosition.x < tablePosition.x - squareWidth / 2 || dragPosition.y < tablePosition.y - squareWidth / 2 || dragPosition.x - table.dom.offsetWidth > tablePosition.x + squareWidth / 2 || dragPosition.y - table.dom.offsetHeight > tablePosition.y + squareWidth / 2) {
            updatePosition = false; //越界
        } else {
            updatePosition = table.checkNoCover(param.dragBrick, Math.round((dragPosition.y - tablePosition.y) / squareWidth), Math.round((dragPosition.x - tablePosition.x) / squareWidth));
        }
        if (updatePosition) {
            param.currentBrick.remove();
            //更新blockList
            if (brickList.isEmpty()) {
                brickList.reCreate();
            }
            //更新table
            table.update(updatePosition, param.dragBrick.color);
            var clearPosition = table.needClear();
            if (clearPosition[0].length || clearPosition[1].length) {
                table.clear(clearPosition[0], clearPosition[1], color.default);
                score += clearPosition[0].length + clearPosition[1].length;
                document.getElementById('score').innerHTML = score;
            }
            //game over
            var notOver = table.checkPossible(brickList);
            if (!notOver) {
                gameover();
            }
        } else {
            param.currentBrick.show();
        }
        //删掉dragBrick
        param.dragBrick.remove();
        //异常鼠标事件
        document.onmouseup = null;
        document.onmousemove = null;
        document.removeEventListener('touchmove', move);
        document.removeEventListener('touchend', up);
    }

    function move(e) {
        e.preventDefault();
        if ('ontouchend' in document) {
            e = e.touches[0];
        }
        var tx = page.pageX(e) - param.x;
        var ty = page.pageY(e) - param.y;
        param.dragBrick.dom.style.left = tx + "px";
        param.dragBrick.dom.style.top = ty + "px";
    }

    function gameover() {
        document.getElementById('titleInfo').innerHTML = 'game over';
        document.getElementById('gg').style.display = 'block';
    }

    var t;
    var countTime = 7;

    function time() {
        document.getElementById('time').innerHTML = countTime--;
        if (countTime < 0) {
            clearInterval(t);
        }
    }
    var t = self.setInterval('time()', 1000);
    </script>
</body>

</html>
